"$schema" = "https://urljsf.rtfd.org/en/latest/_static/urljsf/schema/v0/form.schema.json"

[forms.build]
schema = "./build.schema.toml"
form_data = "./build.data.toml"

[forms.project]
schema = "./project.schema.toml"

[templates]
url = '''
{% import "_pixi_toml" as pt %}
{% import "_jlc_json" as jl %}
{% set ignore = [".pixi", "_output", "*.doit.*"] %}

{{
  {
    ".gitignore": ignore | join("\n"),
    "pixi.toml": (pt.pixi_toml(data) | trim).val,
    "lite": { "jupyter_lite_config.json": (jl.jlc_json(data) | trim).val }
  } | to_zip_url
}}
'''
submit_button = "Download Project Archive"
download_filename = "{{ data.project.name }}.zip"

below_project = """
{% import "_pixi_toml" as pt %}
{% import "_jlc_json" as jl %}

Your `jupyter_lite_config.json`:

```
{{ jl.jlc_json(data) | trim }}
```

Your `pixi.toml`:

```
{{ pt.pixi_toml(data) | trim }}
```
"""

_pixi_toml = '''
{% macro pixi_toml(d) %}

{{
  {
    "project": {
      "name": d.project.name
    },
    "dependencies": {
      "jupyterlite-pyodide-lock-recommended": d.build.jlpl
    },
    "tasks": {
      "build": {
        "cmd": "cd lite && jupyter lite archive"
      },
      "serve": {
        "cmd": "cd lite/_output && python -m http.server -b 127.0.0.1",
        "depends-on": ["build"]
      }
    }
  }
  | prune
  | to_toml
  | replace(r/(\[.*?\]\n)+(\[.*?\]\n)/gm, "$2")
  | replace(r/\n\n(\n+)/g, "\n\n")
  | trim
}}

{% endmacro %}
'''

_jlc_json = '''
{% macro jlc_json(d) %}

{{
  {
    "PyodideLockAddon": {
      "enabled": true,
      "locker": "BrowserLocker",
      "specs": d.build.specs
    }
  }
  | prune
  | to_json
}}

{% endmacro %}
'''

[nunjucks]
filters = ["toml", "json", "zip", "yaml"]
