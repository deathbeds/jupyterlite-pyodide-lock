"$schema" = "https://pixi.sh/v0.59.0/schema/manifest/schema.json"

[workspace]
channels = [
  "conda-forge",
]
name = "jlpl"
platforms = ["linux-64", "osx-64", "win-64", "osx-arm64"]
requires-pixi = ">=0.59.0"
version = "0.1.2"

[tasks]
# top-level tasks a la make phony
all = {cmd = "echo ðŸš¢ OK all", description = """
ðŸš¢ ALL tasks to prepare for a release""", depends-on = [
  "fix",
  "lint",
  "build-pypi",
  "docs",
  "check",
  "test",
  "build",
]}
build = {cmd = "echo ðŸ—ï¸ OK build", description = """
ðŸ—ï¸  build ALL packages""", depends-on = [
  "build-pypi",
  "build-rattler",
  "build-hash",
]}
build-pypi = {cmd = "echo ðŸ OK build-pypi", description = """
ðŸ build ALL PyPI distributions""", depends-on = [
  "build-pypi-core",
  "build-pypi-wd",
  "build-wheel-check",
  "build-wheel-twine",
]}
check = {cmd = "echo ðŸ¤“ OK check", description = """
ðŸ¤“ check all build/test artifacts""", depends-on = ["check-links", "check-spelling"]}
docs = {cmd = "echo ðŸ–¨ï¸ OK docs", description = """
ðŸ–¨ï¸  build all documentation""", depends-on = ["docs-lite", "docs-sphinx"]}
fix = {description = """
ðŸ§¹ fix ALL source files""", cmd = "echo ðŸ§¹ OK fix", depends-on = [
  "fix-deps",
  "fix-ruff",
  "fix-taplo",
  "fix-ipynb",
  "fix-prettier",
  "fix-mdlint",
]}
lint = {cmd = "echo â­ OK lint", description = """
â­ run ALL linters""", depends-on = [
  "lint-ruff",
  "lint-ipynb",
  "lint-actionlint",
  "lint-prettier",
  "lint-mdlint",
]}
pr = {cmd = "echo ðŸ§² OK pr", description = """
ðŸ§² run ALL pull request preflight tasks""", depends-on = [
  "fix",
  "lint",
  "test-meta",
  "check",
]}
test = {cmd = "echo ðŸš€ OK test", description = """
ðŸš€ run ALL tests""", depends-on = [
  "test-meta",
  "test-max",
  "test-min",
]}
test-cli = {cmd = "echo ðŸš— OK cli", description = """
â”œ ðŸ†˜ check CLI in all test environments""", depends-on = [
  "test-min-cli",
  "test-max-cli",
]}
test-max = {cmd = "echo ðŸš— OK test-max", description = """
â”œ ðŸš— run tests in the default test environment""", depends-on = [
  "test-max-cli",
  "test-max-core",
  "test-max-wd",
]}
test-min = {cmd = "echo ðŸŽ OK test-min", description = """
â”œ ðŸŽ run tests in the oldest supported environment""", depends-on = [
  "test-min-cli",
  "test-min-core",
  "test-min-wd",
]}

## fragments ###################################################################
_pip = """
  pixi run --quiet _uv uninstall
    jupyterlite-pyodide-lock
    jupyterlite-pyodide-lock-webdriver
  && pixi run --quiet _uv install
    --no-deps
    --no-build-isolation
    --no-cache
    --offline
    --link-mode copy"""
_pip_check = """
  pixi run _uv check
  && mkdir -p build/pip-freeze
  && pixi run _uv list --format=freeze
  > build/pip-freeze/$PIXI_ENVIRONMENT_NAME.txt"""
_pip_dist = "pixi run _pip --find-links=dist --no-index"
_pip_e_all = """pixi run _pip_check
  && pixi run _pip
    -e py/jupyterlite-pyodide-lock
    -e py/jupyterlite-pyodide-lock-webdriver
  && pixi run _pip_check"""
_this_python = "echo UV_PYTHON=$(python -c 'import sys; print(sys.executable)')"
_uv = "pixi run --quiet --environment=uv uv pip"

## templates ###################################################################
[tasks._pip_whl_all]
args = ["env"]
cmd = """
  export $(pixi run --quiet --environment={{ env }} _this_python)
  && pixi run --environment={{ env }} _pip_check
  && pixi run --environment={{ env }} _pip_dist
    jupyterlite-pyodide-lock
    jupyterlite-pyodide-lock-webdriver
  && pixi run --environment={{ env }} _pip_check"""
depends-on = ["build-pypi-core", "build-pypi-wd"]
inputs = ["dist/*.whl"]
outputs = ["build/pip-freeze/{{ env }}.txt"]

[tasks._cli_check]
args = ["env"]
cmd = "pixi run --environment={{ env }} jupyter-pyodide-lock browsers --check"
inputs = ["build/pip-freeze/{{ env }}.txt", "dist/*.whl"]

[tasks._pytest]
args = ["env", "pkg", {arg = "cov", default = "100"}]
cmd = """export REPORT=$(pwd)/build/reports/{{ env }}/{{ pkg }}
  && export COVERAGE_FILE=$REPORT/.coverage
  && export COVERAGE_RCFILE=$(pwd)/pyproject.toml
  && export JUPYTERLITE_NO_LIBARCHIVE=1
  && rm --recursive --force $REPORT
  && mkdir --parents $REPORT
  && cd py/{{ pkg }}
  && pixi run --environment={{ env }} pytest tests
    -vv
    --pythonwarnings=error
    --rootdir=.
    --color=yes
    --tb=long
    --cov-branch
    --cov-context=test
    --cov-report=html:$REPORT/htmlcov
    --cov-report=term-missing:skip-covered
    --cov={{ pkg | replace("-", "_") }}
    --no-cov-on-fail
    --cov-fail-under={{ cov }}
    --html=$REPORT/pytest.html
    --self-contained-html
    --override-ini=generate_report_on_test=True
    --override-ini=cache_dir=$PIXI_PROJECT_ROOT/build/.cache/{{ pkg }}/pytest
    || exit 1"""
inputs = ["py/{{ pkg }}/tests/**/*.py", "dist/*.whl"]
outputs = ["build/reports/{{ env }}/{{ pkg }}/{pytest.html,htmlcov/status.json}"]

[tasks._pytest_core]
args = ["env"]
depends-on = [
  {task = "_pytest", args = ["{{ env }}", "jupyterlite-pyodide-lock", "99"]},
]

[tasks._pytest_wd]
args = ["env"]
depends-on = [
  {task = "_pytest", args = ["{{ env }}", "jupyterlite-pyodide-lock-webdriver"]},
]

# real tasks ###################################################################
## linting #####################################################################
[feature.tasks-lint.tasks.fix-deps]
cmd = """python _scripts/fix-deps.py
    py/jupyterlite-pyodide-lock/pyproject.toml
    py/jupyterlite-pyodide-lock-webdriver/pyproject.toml"""
description = "â”œ fix dependencies"
inputs = ["_scripts/fix-deps.py", "py/jupyterlite-pyodide-lock/pyproject.toml"]
outputs = ["py/*/pyproject.toml"]

[feature.tasks-lint.tasks.fix-ipynb]
cmd = "python _scripts/nb-lint.py --fix docs"
description = "â”œ fix notebooks"
inputs = ["_scripts/nb-lint.py", "docs/**/*.ipynb", "!**/.*"]

[feature.tasks-lint.tasks.lint-ipynb]
cmd = "python _scripts/nb-lint.py docs"
description = "â”œ check notebooks"
inputs = ["_scripts/nb-lint.py", "docs/**/*.ipynb", "!**/.*"]

[feature.tasks-lint.tasks.fix-ruff]
cmd = "ruff check --fix-only && ruff format"
depends-on = ["fix-conftest"]
description = "â”œ fix python with ruff"
inputs = [
  "{_scripts,py,tests,docs,contrib}/**/*.{ipynb,py}",
  "pyproject.toml",
  "!**/.*",
]

[feature.tasks-lint.tasks.lint-ruff]
cmd = "ruff check && ruff format --check"
description = "â”œ check python with ruff"
inputs = [
  "{_scripts,py,tests,docs,contrib}/**/*.{ipynb,py}",
  "pyproject.toml",
  "!**/.*",
]

[feature.tasks-lint.tasks.fix-taplo]
cmd = """taplo fmt
    --option=array_auto_collapse=false
    --option=array_auto_expand=true
    --option=reorder_keys=true
    --option=compact_inline_tables=true
    --option=inline_table_expand=false
    --option=column_width=88
    --option=indent_string="  "
    pyproject.toml
    pixi.toml
    py/*/*.toml
    docs/*.toml"""
depends-on = ["fix-deps"]
description = "â”œ fix toml with taplo"
inputs = ["*.toml", "{py,docs}/**/*.toml", "!**/.*"]

[feature.tasks-lint.tasks.fix-conftest]
cmd = """python _scripts/replace-between.py
    py/jupyterlite-pyodide-lock/tests/conftest.py
    py/jupyterlite-pyodide-lock-webdriver/tests/conftest.py
    "# shared fixtures ###" """
depends-on = ["fix-deps"]
description = "â”œ add templated conftest"
inputs = [
  "py/jupyterlite-pyodide-lock/tests/conftest.py",
  "_scripts/replace-between.py",
]
outputs = ["py/jupyterlite-pyodide-lock-webdriver/tests/conftest.py"]

[feature.tasks-lint.tasks.lint-actionlint]
cmd = "actionlint -shellcheck=shellcheck -pyflakes=pyflakes"
description = "â”œ check GitHub actions with actionlint"
inputs = [".github/workflows"]

[feature.tasks-lint.tasks._prettier]
cmd = """prettier
  --config=_scripts/package.json
  --cache
  --cache-location=build/.cache/prettier
  "*.md"
  docs/.readthedocs.yaml
  "{.github,_scripts,docs,examples,py,recipe}/**/*.{yml,yaml,md,json}"
  """

[feature.tasks-lint.tasks.fix-prettier]
cmd = "pixi run _prettier --write --list-different"
description = "â”œ format web-adjacent files with prettier"
inputs = [
  "*.md",
  ".github",
  "docs/.readthedocs.yaml",
  "{.github,_scripts,docs,examples,py,recipe}/**/*.{yml,md,json,css}",
]

[feature.tasks-lint.tasks.lint-prettier]
cmd = "pixi run _prettier --check"
description = "â”œ check web-adjacent files with prettier"
inputs = [
  "*.md",
  "docs/.readthedocs.yaml",
  "{.github,_scripts,docs,examples,py,recipe}/**/*.{yml,md,json,css}",
]

[feature.tasks-lint.tasks._mdlint]
cmd = """markdownlint-cli2
  --config _scripts/.markdownlint.yaml
  ".github/**/*.md"
  "_scripts/**/*.md"
  "docs/**/*.md"
  "examples/**/*.md"
  "py/**/*.md"
  "!**/.ipynb_checkpoints"
  *.md"""

[feature.tasks-lint.tasks.fix-mdlint]
cmd = "pixi run _mdlint --fix"
depends-on = ["fix-prettier"]
description = "â”œ format markdown files with markdownlint2-cli"
inputs = [
  "*.md",
  "_scripts/.markdownlint.yaml",
  "{.github,_scripts,docs,examples,py}/**/*.md",
]

[feature.tasks-lint.tasks.lint-mdlint]
cmd = "pixi run _mdlint"
description = "â”œ check markdown files with markdownlint2-cli"
inputs = [
  "*.md",
  "_scripts/.markdownlint.yaml",
  "{.github,_scripts,docs,examples,py}/**/*.md",
]

# building #####################################################################
[feature.tasks-build.tasks._pyproject_build]
args = ["pkg"]
cmd = """(cat .pixi/task-cache-v0/.skip-pypi-dist && exit 0)
  || mkdir -p dist
  && (rm --recursive --force dist/{{ pkg | replace('-', '_') }}-* || echo "nothing to delete")
  && cd py/{{ pkg }}
  && rm --recursive --force dist
  && pyproject-build . --no-isolation -vv
  && cp dist/* $PIXI_PROJECT_ROOT/dist"""
inputs = [
  "py/{{ pkg }}/**/*.{py,toml,md,j2}",
  "!**/{.*,__pycache__,dist}",
]
outputs = ["dist/{{ pkg | replace('-', '_') }}-*.{tar.gz,whl}"]

[feature.tasks-build.tasks.build-licenses]
cmd = """cp LICENSE py/jupyterlite-pyodide-lock-webdriver/LICENSE
  && cp LICENSE py/jupyterlite-pyodide-lock/LICENSE"""
description = "â”œ ensure licenses in contrib packages"
inputs = ["LICENSE"]
outputs = ["py/*/LICENSE"]

[feature.tasks-build.tasks.build-pypi-core]
depends-on = [{task = "_pyproject_build", args = ["jupyterlite-pyodide-lock"]}]
description = "â”œâ”€ build core PyPI distributions"

[feature.tasks-build.tasks.build-pypi-wd]
depends-on = [
  "build-licenses",
  {task = "_pyproject_build", args = ["jupyterlite-pyodide-lock-webdriver"]},
]
description = "â”œâ”€ build webdriver PyPI distributions"

[feature.tasks-build.tasks.build-wheel-twine]
cmd = "twine check --strict dist/*.whl dist/*.tar.gz"
depends-on = ["build-pypi-core", "build-pypi-wd"]
description = "â”œ check the built distributions for PyPI"
inputs = ["dist/"]

[feature.tasks-build.tasks.build-wheel-check]
cmd = "check-wheel-contents dist/*.whl"
depends-on = ["build-pypi-core", "build-pypi-wd"]
description = "â”œ check the built wheels"
inputs = ["dist/*.whl"]

[feature.tasks-build.tasks.build-hash]
cmd = """rm --recursive --force dist/SHA256SUMS
  && python -c 'from hashlib import sha256; from pathlib import Path; d = Path("dist"); [
    print(f"{sha256(p.read_bytes()).hexdigest()}  {p.relative_to(d).as_posix()}")
    for p in sorted(d.rglob("*"))
    if p.is_file() and p.name != "SHA256SUMS"
  ]'
  > dist/SHA256SUMS
  && cat dist/SHA256SUMS"""
depends-on = ["build-pypi-core", "build-pypi-wd"]
description = "â”œ hash the built distributions"
inputs = ["dist", "!dist/SHA256SUMS"]
outputs = ["dist/SHA256SUMS"]

# conda ########################################################################
[feature.tasks-rattler.tasks.build-rattler]
cmd = """export JLPL_GIT_DESCRIBE=0
&& rm --recursive --force dist/noarch
&& mkdir -p build/rattler-build
&& rattler-build build
  --experimental
  --color=always
  --verbose
  --channel conda-forge
  --recipe recipe
  --output-dir build/rattler-build
&& cp -r build/rattler-build/noarch dist/noarch"""
depends-on = ["build-pypi-core", "build-pypi-wd"]
description = "â”œ build for conda distribution"
inputs = ["dist/*.tar.gz", "recipe"]
outputs = ["dist/*/*.conda"]

# testing ######################################################################
## testing meta ################################################################
[feature.tasks-test-repo.tasks.test-meta]
cmd = """cd py/jupyterlite-pyodide-lock && pytest -k test_repo -vv"""
depends-on = ["test-max-pip"]
inputs = [
  ".github",
  "CHANGELOG",
  "docs/form",
  "pixi.toml",
  "py/*/pyproject.toml",
  "py/jupyterlite-pyodide-lock/tests/test_repo.py",
]

## testing minimum #############################################################
[feature.tasks-test-min.tasks]
test-min-cli = {description = "â”œâ”€ smoke test browsers in min test environment", depends-on = [
  "test-min-pip",
  {task = "_cli_check", args = ["test-min"]},
]}
test-min-core = {description = "â”œâ”€ test core in the min test environment", depends-on = [
  "test-min-cli",
  {task = "_pytest_core", args = ["test-min"]},
]}
test-min-pip = {description = "â”œâ”€ prepare the min test environment with pip", depends-on = [
  {task = "_pip_whl_all", args = ["test-min"]},
]}
test-min-wd = {description = "â”œâ”€ test webdriver in the min test environment", depends-on = [
  "test-min-cli",
  {task = "_pytest_wd", args = ["test-min"]},
]}

## testing default #############################################################
[feature.tasks-test-max.tasks]
test-max-cli = {description = "â”œâ”€ smoke test browsers in default test environment", depends-on = [
  "test-max-pip",
  {task = "_cli_check", args = ["test-max"]},
]}
test-max-core = {description = "â”œâ”€ test core in the default test environment", depends-on = [
  "test-max-cli",
  {task = "_pytest_core", args = ["test-max"]},
]}
test-max-pip = {description = "â”œâ”€ prepare the default test environment with pip", depends-on = [
  {task = "_pip_whl_all", args = ["test-max"]},
]}
test-max-wd = {description = "â”œâ”€ test webdriver in the default test environment", depends-on = [
  "test-max-cli",
  {task = "_pytest_wd", args = ["test-max"]},
]}

# docs #########################################################################
[feature.tasks-docs.tasks.docs-pip]
depends-on = [{task = "_pip_whl_all", args = ["docs"]}]
description = "â”œ prepare the docs environment with pip"

[feature.tasks-docs.tasks.docs-scour]
cmd = """export SCOUR_ARGS="scour --enable-id-stripping --enable-comment-stripping"
  && cd docs/_static
  && $SCOUR_ARGS icon-inkscape.svg icon.svg"""
description = "â”œ optimize SVG for docs with scour"
inputs = ["docs/_static/*-inkscape.svg"]
outputs = ["docs/_static/*.svg", "docs/_static/*.svg", "!*inkscape.svg"]

[feature.tasks-docs.tasks.docs-lite]
cmd = """cd examples
  && jupyter-lite doit --debug -- pre_archive:report:SHA256SUMS"""
depends-on = ["docs-pip"]
description = "â”œ build a demo site with jupyter-lite"
inputs = ["examples", "py/**/*.py", "!**/.*"]
outputs = ["build/docs-app/SHA256SUMS"]

[feature.tasks-docs.tasks.docs-sphinx]
cmd = """rm --recursive --force build/docs
  && cd docs
  && export PYDEVD_DISABLE_FILE_VALIDATION=1
  && sphinx-build -W --keep-going --color -b html . ../build/docs"""
depends-on = ["build-hash", "docs-lite", "docs-scour"]
description = "â”œ build documentation with sphinx"
inputs = [
  "*.md",
  "pixi.toml",
  "py/*/*.toml",
  "py/*/src/**/*.py",
  "build/docs-app/SHA256SUMS",
  "dist/*.whl",
  "docs/**/*.{css,ipynb,md,py,toml}",
  "!**/.*",
  "!**/{__pycache__,vale}",
]
outputs = ["build/docs/.buildinfo"]

[feature.tasks-docs.tasks.docs-rtd]
cmd = """python -c "
import os;
assert all(map(os.getenv, ['READTHEDOCS', 'READTHEDOCS_OUTPUT'])), 'not on ReadTheDocs'
"
  && rm --recursive --force "$READTHEDOCS_OUTPUT/html"
  && mkdir -p "$READTHEDOCS_OUTPUT"
  && cp -r build/docs "$READTHEDOCS_OUTPUT/html"
  && ls -lathr "$READTHEDOCS_OUTPUT/html"
"""
description = "â”œ copy the documentation site to where ReadTheDocs wants it"

# checking
[feature.tasks-check.tasks.check-links]
cmd = """rm --recursive --force build/reports/check-links
  && mkdir -p build/reports/check-links
  && cd build/reports/check-links
  && touch pytest.ini
  && pytest
    -c pytest.ini
    --rootdir=.
    -p no:importnb
    --check-links
    --check-links-ignore '^https?://'
    -k "not _modules/index.html"
    ../../docs/**/*.html"""
depends-on = ["docs-sphinx"]
description = "â”œ check links in html"
inputs = ["build/docs/**/*.html"]

[feature.tasks-check.tasks.check-spelling]
cmd = "python _scripts/vale/check.py"
depends-on = ["docs-sphinx"]
description = "â”œ check spelling in documentation"
inputs = [
  "build/docs/**/*.html",
  "_scripts/vale",
  "{py,_scripts,atest}/**/*.py",
  "!**/.*",
]
outputs = ["build/reports/vale.html"]

# interactive development ######################################################
[feature.tasks-dev.tasks.dev-pip]
cmd = """pixi run -e dev _pip_e_all"""
description = "â”œ prepare the dev environment"
outputs = ["build/pip-freeze/dev.txt"]

[feature.tasks-dev.tasks.dev-lab]
cmd = """jupyter lab --no-browser --debug"""
depends-on = ["dev-pip"]
description = "â”œ ðŸ” serve JupyterLab in the dev environment"

[feature.tasks-dev.tasks.dev-docs]
cmd = """sphinx-autobuild -b html docs build/dev-docs
    --write-all
    --color
    --watch README.md
    --watch pixi.toml
    --watch pyproject.toml
    --watch build/docs-app
    --watch py/jupyterlite-pyodide-lock/src
    --watch py/jupyterlite-pyodide-lock-webdriver/src"""
depends-on = ["dev-pip", "docs-sphinx"]
description = "â”œ ðŸ” watch and serve the documentation with autoreload"

[feature]
# meta features ################################################################
deps--oldest.solve-strategy = "lowest-direct"
# singletons
deps-flit.dependencies.flit-core = ">=3.12,<4.0"
deps-rattler.dependencies.rattler-build = "*"
deps-uv.dependencies.uv = "*"
deps-webdriver.dependencies.selenium = ">=4.19"

# dependencies #################################################################
[feature.deps-run.dependencies]
jupyterlite-core = ">=0.3.0,<0.8.0"
jupyterlite-pyodide-kernel = ">=0.3.1,<0.8.0"
psutil = ">=6"
pyodide-lock = ">=0.1.0a4,<0.2"
pyodide-lock-with-wheel = "*"
python = ">=3.10"
tornado = ">=6.1.0"

[feature.deps-run-max.dependencies]
jupyterlite-core = "0.5.*"
jupyterlite-pyodide-kernel = "0.5.*"
pyodide-lock = "==0.1.0a6"
python = "3.12.*"

[feature.deps-build.dependencies]
check-wheel-contents = "*"
python-build = "*"
twine = "*"

[feature.deps-lint.dependencies]
actionlint-with-all = "*"
markdownlint-cli2 = "*"
nbformat = "*"
nodejs = ">=22,!=22.13.0,<23"
prettier = "*"
ruff = "*"
taplo = "*"
tomli-w = "*"
tomlkit = "*"
types-psutil = "*"

[feature.deps-test.dependencies]
jupyter_server = ">=2"
pytest = ">=8,<9"
pytest-cov = ">=7"
pytest-html = ">=4"

[feature.deps-firefox.dependencies]
firefox = ">=140"
geckodriver = ">=0.36"

[feature.deps-docs.dependencies]
autodoc-traits = ">=1.2.2"
importnb = "*"
jinja2 = ">=2.9"
myst-nb = "*"
packaging = "*"
pydata-sphinx-theme = "*"
pypandoc = "*"
python-libarchive-c = "*"
requests = "*"
scour = "*"
sphinx = "*"
sphinx-autodoc-typehints = "*"
sphinx-copybutton = "*"

[feature.deps-check.dependencies]
pytest-check-links = "*"
vale = "<3.9.4"
vale-spelling-aoo-mozilla-en-dict-us = "*"

[feature.deps-dev.dependencies]
sphinx-autobuild = "*"
watchfiles = "*"

[feature.deps-demo.dependencies]
ipywidgets = ">=8.1,<8.2"
jupyterlab = ">=4.1,<4.5"

# environments #################################################################
[environments]
build = {features = ["deps-build", "deps-flit", "tasks-build"]}
dev = {features = [
  "deps-build",
  "deps-demo",
  "deps-dev",
  "deps-docs",
  "deps-lint",
  "deps-flit",
  "deps-run",
  "deps-test",
  "deps-webdriver",
  "tasks-dev",
]}
docs = {features = [
  "deps-build",
  "deps-check",
  "deps-demo",
  "deps-docs",
  "deps-firefox",
  "deps-flit",
  "deps-run",
  "deps-webdriver",
  "tasks-check",
  "tasks-docs",
]}
lint = {features = ["deps-lint", "tasks-lint"]}
rattler = ["deps-rattler", "tasks-rattler"]
test-max = {features = [
  "deps-firefox",
  "deps-flit",
  "deps-run-max",
  "deps-run",
  "deps-test",
  "deps-webdriver",
  "tasks-test-repo",
  "tasks-test-max",
]}
test-min = {features = [
  "deps--oldest",
  "deps-firefox",
  "deps-flit",
  "deps-run",
  "deps-test",
  "deps-webdriver",
  "tasks-test-min",
]}
uv = ["deps-uv"]
